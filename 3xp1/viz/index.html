<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Collatz Reverse Editor</title>
    <style>
        body {
            font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
            background: #f0f4f8;
            color: #1f2937;
            margin: 0;
            padding: 2rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
        }

        h1 {
            margin-bottom: 1rem;
            font-weight: 700;
            text-align: center;
        }

        input[type="number"].top-input {
            width: 140px;
            font-size: 2rem;
            padding: 0.3rem 0.5rem;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            text-align: center;
            outline-offset: 2px;
            margin-bottom: 2rem;
            transition: border-color 0.3s;
        }

        input[type="number"].top-input:focus {
            border-color: #2563eb;
        }

        .steps-container {
            display: flex;
            flex-direction: column;
            gap: 0.8rem;
            width: 120px;
        }

        .step-row {
            display: flex;
            align-items: center;
        }

        input.step-input {
            width: 100%;
            font-weight: 700;
            font-size: 1.5rem;
            padding: 0.4rem 0;
            border-radius: 8px;
            border: 2px solid #3b82f6;
            text-align: center;
            color: #1f2937;
            outline-offset: 2px;
            transition: border-color 0.3s;
        }

        input.step-input:focus {
            border-color: #2563eb;
        }

        button.delete-btn {
            background: transparent;
            border: none;
            color: #ef4444;
            font-weight: 700;
            font-size: 1.4rem;
            margin-left: 6px;
            cursor: pointer;
            user-select: none;
            line-height: 1;
        }

        button.delete-btn:hover {
            color: #b91c1c;
        }

        button#addStepBtn {
            margin-top: 1rem;
            padding: 0.5rem 0;
            width: 120px;
            font-size: 2rem;
            font-weight: 700;
            border-radius: 12px;
            border: none;
            background: #3b82f6;
            color: white;
            cursor: pointer;
            user-select: none;
            box-shadow: 0 3px 6px rgba(59, 130, 246, 0.5);
            transition: background-color 0.3s;
        }

        button#addStepBtn:hover {
            background: #2563eb;
        }

        p.error-msg {
            color: #dc2626;
            font-weight: 700;
            min-height: 1.3em;
            margin-top: 1rem;
            text-align: center;
        }
    </style>
</head>

<body>

    <h1>Collatz Reverse Editor</h1>
    <input id="startNumber" class="top-input" type="number" min="1" step="1" value="7" aria-label="Starting number" />

    <div id="steps" class="steps-container" aria-live="polite" aria-atomic="true"></div>
    <button id="addStepBtn" aria-label="Add step level">+</button>
    <p id="errorMsg" class="error-msg" role="alert" aria-live="assertive"></p>

    <script>
        // Forward function: f(x,n) = (x*2^n -1)/3
        function f(x, n) {
            return (x * Math.pow(2, n) - 1) / 3;
        }
        // Given steps array, reconstruct number by nested f starting from 1
        function reconstructFromSteps(steps) {
            let x = 1;
            for (const n of steps) {
                if (n < 1 || !Number.isInteger(n)) return null;
                x = f(x, n);
                if (!Number.isInteger(x)) return null;
            }
            return x;
        }
        // Build steps array (reverse Collatz)
        function buildStepsArray(start) {
            if (start < 1 || !Number.isInteger(start) || start % 2 === 0) return [];
            let steps = [];
            let x = start;
            while (x !== 1) {
                const val = 3 * x + 1;
                let n = 0;
                let y = val;
                while (y % 2 === 0) {
                    y /= 2;
                    n++;
                }
                if (!Number.isInteger(y) || y % 2 === 0 || y < 1) return [];
                steps.push(n);
                x = y;
            }
            return steps.reverse(); // correct order for reconstruction
        }
        // DOM elements
        const startInput = document.getElementById('startNumber');
        const stepsContainer = document.getElementById('steps');
        const addStepBtn = document.getElementById('addStepBtn');
        const errorMsg = document.getElementById('errorMsg');
        // Render steps input boxes
        function renderStepBoxes(steps) {
            stepsContainer.innerHTML = '';
            steps.forEach((step, index) => {
                const row = document.createElement('div');
                row.className = 'step-row';
                const input = document.createElement('input');
                input.type = 'number';
                input.min = 1;
                input.step = 2;
                input.value = step;
                input.className = 'step-input';
                input.setAttribute('aria-label', `Step level ${index + 1}`);
                input.dataset.index = index;
                input.addEventListener('input', () => {
                    const newSteps = getStepsFromInputs();
                    if (!newSteps) return;
                    const newStart = reconstructFromSteps(newSteps);
                    if (newStart === null) {
                        showError('Invalid steps sequence. Cannot reconstruct a valid number.');
                    } else {
                        hideError();
                        startInput.value = newStart;
                        currentSteps = newSteps;
                    }
                });
                const delBtn = document.createElement('button');
                delBtn.textContent = 'Ã—';
                delBtn.className = 'delete-btn';
                delBtn.setAttribute('aria-label', `Delete step level ${index + 1}`);
                delBtn.addEventListener('click', () => {
                    steps.splice(index, 1);
                    if (steps.length === 0) steps.push(1);
                    renderStepBoxes(steps);
                    const newStart = reconstructFromSteps(steps);
                    if (newStart !== null) {
                        hideError();
                        startInput.value = newStart;
                        currentSteps = steps;
                    } else {
                        showError('Invalid steps sequence after deletion.');
                    }
                });
                row.appendChild(input);
                row.appendChild(delBtn);
                stepsContainer.appendChild(row);
            });
        }
        // Extract steps from inputs
        function getStepsFromInputs() {
            const inputs = stepsContainer.querySelectorAll('input.step-input');
            const steps = [];
            for (const input of inputs) {
                const val = Number(input.value);
                if (!Number.isInteger(val) || val < 1) return null;
                steps.push(val);
            }
            return steps;
        }

        function showError(msg) {
            errorMsg.textContent = msg;
        }

        function hideError() {
            errorMsg.textContent = '';
        }
        // Initialize
        let currentSteps = buildStepsArray(Number(startInput.value));
        if (currentSteps.length === 0) currentSteps = [1];
        renderStepBoxes(currentSteps);
        // On top input change
        startInput.addEventListener('input', () => {
            const val = Number(startInput.value);
            if (!Number.isInteger(val) || val < 1) {
                showError('Please enter a positive integer.');
                return;
            }
            const steps = buildStepsArray(val);
            if (steps.length === 0) {
                showError('Could not derive steps for this number.');
                return;
            }
            hideError();
            currentSteps = steps;
            renderStepBoxes(currentSteps);
        });
        // Add new step
        addStepBtn.addEventListener('click', () => {
            currentSteps.push(1);
            renderStepBoxes(currentSteps);
            const newStart = reconstructFromSteps(currentSteps);
            if (newStart === null) {
                showError('Invalid steps sequence after adding a step.');
            } else {
                hideError();
                startInput.value = newStart;
            }
        });
    </script>

</body>

</html>